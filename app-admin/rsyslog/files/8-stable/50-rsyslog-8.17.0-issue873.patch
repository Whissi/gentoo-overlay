From d9d6df8ea6cf2a4be4146b735aca76e4cf651b4e Mon Sep 17 00:00:00 2001
From: Thomas D.
Date: Fri, 11 Mar 2016 17:05:37 +0100
Subject: [PATCH 1/2] testbench: Fix testnames

---
 tests/now-utc-casecmp.sh                 | 2 +-
 tests/now-utc-ymd.sh                     | 2 +-
 tests/timegenerated-dateordinal-invld.sh | 2 +-
 tests/timegenerated-dateordinal.sh       | 2 +-
 tests/timegenerated-uxtimestamp.sh       | 2 +-
 tests/timegenerated-ymd.sh               | 2 +-
 6 files changed, 6 insertions(+), 6 deletions(-)

diff --git a/tests/now-utc-casecmp.sh b/tests/now-utc-casecmp.sh
index b50b826..2e93511 100755
--- a/tests/now-utc-casecmp.sh
+++ b/tests/now-utc-casecmp.sh
@@ -2,7 +2,7 @@
 # test many concurrent tcp connections
 # addd 2016-02-23 by RGerhards, released under ASL 2.0
 # requires faketime
-echo \[now-utc\]: test \$year-utc, \$month-utc, \$day-utc
+echo \[now-utc-casecmp\]: test \$year-utc, \$month-utc, \$day-utc
 export TZ=TEST-02:00
 faketime '2016-01-01 01:00:00' date
 if [ $? -ne 0 ]; then
diff --git a/tests/now-utc-ymd.sh b/tests/now-utc-ymd.sh
index b9792b6..1baeab2 100755
--- a/tests/now-utc-ymd.sh
+++ b/tests/now-utc-ymd.sh
@@ -2,7 +2,7 @@
 # test many concurrent tcp connections
 # addd 2016-02-23 by RGerhards, released under ASL 2.0
 # requires faketime
-echo \[now-utc\]: test \$year-utc, \$month-utc, \$day-utc
+echo \[now-utc-ymd\]: test \$year-utc, \$month-utc, \$day-utc
 export TZ=TEST-02:00
 faketime '2016-01-01 01:00:00' date
 if [ $? -ne 0 ]; then
diff --git a/tests/timegenerated-dateordinal-invld.sh b/tests/timegenerated-dateordinal-invld.sh
index fc28b48..9f19e7b 100755
--- a/tests/timegenerated-dateordinal-invld.sh
+++ b/tests/timegenerated-dateordinal-invld.sh
@@ -4,7 +4,7 @@
 # the key point of this test is that we do not abort and
 # instead provide the defined return value (0)
 # requires faketime
-echo \[timegenerated-uxtimestamp-invld\]: check invalid dates with uxtimestamp format
+echo \[timegenerated-dateordinal-invld\]: check invalid dates with ordinal format
 export TZ=UTC+00:00
 faketime -f '2216-03-01 12:00:00' date
 if [ $? -ne 0 ]; then
diff --git a/tests/timegenerated-dateordinal.sh b/tests/timegenerated-dateordinal.sh
index 8c0e681..a2193b1 100755
--- a/tests/timegenerated-dateordinal.sh
+++ b/tests/timegenerated-dateordinal.sh
@@ -4,7 +4,7 @@
 # Note: we run several subtests here in order to save us
 # from creating additional tests
 # requires faketime
-echo \[timegenerated-uxtimestamp\]: 
+echo \[timegenerated-dateordinal\]: check valid dates with ordinal format
 export TZ=UTC+00:00
 faketime -f '2016-03-01 12:00:00' date
 if [ $? -ne 0 ]; then
diff --git a/tests/timegenerated-uxtimestamp.sh b/tests/timegenerated-uxtimestamp.sh
index 72533b0..4c06d23 100755
--- a/tests/timegenerated-uxtimestamp.sh
+++ b/tests/timegenerated-uxtimestamp.sh
@@ -4,7 +4,7 @@
 # Note: we run several subtests here in order to save us
 # from creating additional tests
 # requires faketime
-echo \[timegenerated-uxtimestamp\]: 
+echo \[timegenerated-uxtimestamp\]: check valid dates with uxtimestamp format
 export TZ=UTC+00:00
 faketime -f '2016-03-01 12:00:00' date
 if [ $? -ne 0 ]; then
diff --git a/tests/timegenerated-ymd.sh b/tests/timegenerated-ymd.sh
index fd5a01c..e512b17 100755
--- a/tests/timegenerated-ymd.sh
+++ b/tests/timegenerated-ymd.sh
@@ -2,7 +2,7 @@
 # test many concurrent tcp connections
 # addd 2016-02-23 by RGerhards, released under ASL 2.0
 # requires faketime
-echo \[timegenerated-ymd\]: 
+echo \[timegenerated-ymd\]: check customized format \(Y-m-d\)
 export TZ=TEST-02:00
 faketime '2016-01-01 01:00:00' date
 if [ $? -ne 0 ]; then

From 3430c8b238f2b3c9633e56b5980defff7d8ff69a Mon Sep 17 00:00:00 2001
From: Thomas D.
Date: Fri, 11 Mar 2016 17:07:08 +0100
Subject: [PATCH 2/2] testbench: Run year-2038 tests only on systems which
 supports those dates

Fixes: https://github.com/rsyslog/rsyslog/issues/873
---
 tests/Makefile.am                        |  1 +
 tests/faketime_common.sh                 | 33 ++++++++++++++++++++++++++++++++
 tests/now-utc-casecmp.sh                 |  9 ++++-----
 tests/now-utc-ymd.sh                     |  9 ++++-----
 tests/now-utc.sh                         |  9 ++++-----
 tests/now_family_utc.sh                  |  9 ++++-----
 tests/timegenerated-dateordinal-invld.sh |  9 ++++-----
 tests/timegenerated-dateordinal.sh       | 12 +++++++-----
 tests/timegenerated-uxtimestamp-invld.sh |  9 ++++-----
 tests/timegenerated-uxtimestamp.sh       | 12 +++++++-----
 tests/timegenerated-ymd.sh               |  9 ++++-----
 11 files changed, 76 insertions(+), 45 deletions(-)
 create mode 100644 tests/faketime_common.sh

diff --git a/tests/Makefile.am b/tests/Makefile.am
index e795ca2..a157435 100644
--- a/tests/Makefile.am
+++ b/tests/Makefile.am
@@ -621,6 +621,7 @@ EXTRA_DIST= \
 	now-utc-casecmp.sh \
 	now-utc.sh \
 	testsuites/now-utc.conf \
+	faketime_common.sh \
 	timegenerated-ymd.sh \
 	timegenerated-uxtimestamp.sh \
 	timegenerated-uxtimestamp-invld.sh \
diff --git a/tests/faketime_common.sh b/tests/faketime_common.sh
new file mode 100644
index 0000000..4a648ca
--- /dev/null
+++ b/tests/faketime_common.sh
@@ -0,0 +1,33 @@
+#!/bin/bash
+# addd 2016-03-11 by Thomas D., released under ASL 2.0
+# Several tests make use of faketime. They all need to know when
+# faketime is missing or the system isn't year-2038 complaint.
+# This script can be sourced to prevent duplicated code.
+
+if ! hash faketime 2>/dev/null ; then
+    echo "faketime command missing, skipping test"
+    exit 77
+fi
+
+export TZ=UTC+01:00
+
+faketime -f '2016-03-11 16:00:00' date 1>/dev/null 2>&1
+if [ $? -ne 0 ]; then
+    # Safe-guard -- should never happen!
+    echo "faketime command not working as expected. Check faketime binary in path!"
+    exit 1
+fi
+
+faketime '2040-01-01 16:00:00' date 1>/dev/null 2>&1
+if [ $? -ne 0 ]; then
+    # System isn't year-2038 compatible
+    RSYSLOG_TESTBENCH_Y2K38_INCOMPATIBLE="yes"
+fi
+
+
+rsyslog_testbench_require_y2k38_support() {
+  if [ -n "${RSYSLOG_TESTBENCH_Y2K38_INCOMPATIBLE}" ]; then
+    echo "Skipping further tests because system doesn't support year 2038 ..."
+    exit 0
+  fi
+}
diff --git a/tests/now-utc-casecmp.sh b/tests/now-utc-casecmp.sh
index 2e93511..59c61a7 100755
--- a/tests/now-utc-casecmp.sh
+++ b/tests/now-utc-casecmp.sh
@@ -3,12 +3,11 @@
 # addd 2016-02-23 by RGerhards, released under ASL 2.0
 # requires faketime
 echo \[now-utc-casecmp\]: test \$year-utc, \$month-utc, \$day-utc
+
+. $srcdir/faketime_common.sh
+
 export TZ=TEST-02:00
-faketime '2016-01-01 01:00:00' date
-if [ $? -ne 0 ]; then
-    echo "faketime command missing, skipping test"
-    exit 77
-fi
+
 . $srcdir/diag.sh init
 . $srcdir/diag.sh generate-conf
 . $srcdir/diag.sh add-conf '
diff --git a/tests/now-utc-ymd.sh b/tests/now-utc-ymd.sh
index 1baeab2..868138c 100755
--- a/tests/now-utc-ymd.sh
+++ b/tests/now-utc-ymd.sh
@@ -3,12 +3,11 @@
 # addd 2016-02-23 by RGerhards, released under ASL 2.0
 # requires faketime
 echo \[now-utc-ymd\]: test \$year-utc, \$month-utc, \$day-utc
+
+. $srcdir/faketime_common.sh
+
 export TZ=TEST-02:00
-faketime '2016-01-01 01:00:00' date
-if [ $? -ne 0 ]; then
-    echo "faketime command missing, skipping test"
-    exit 77
-fi
+
 . $srcdir/diag.sh init
 . $srcdir/diag.sh generate-conf
 . $srcdir/diag.sh add-conf '
diff --git a/tests/now-utc.sh b/tests/now-utc.sh
index 6c4cc3b..0874f05 100755
--- a/tests/now-utc.sh
+++ b/tests/now-utc.sh
@@ -3,12 +3,11 @@
 # addd 2016-02-23 by RGerhards, released under ASL 2.0
 # requires faketime
 echo \[now-utc\]: test \$NOW-UTC
+
+. $srcdir/faketime_common.sh
+
 export TZ=TEST-02:00
-faketime '2016-01-01 01:00:00' date
-if [ $? -ne 0 ]; then
-    echo "faketime command missing, skipping test"
-    exit 77
-fi
+
 . $srcdir/diag.sh init
 faketime '2016-01-01 01:00:00' $srcdir/diag.sh startup now-utc.conf
 # what we send actually is irrelevant, as we just use system properties.
diff --git a/tests/now_family_utc.sh b/tests/now_family_utc.sh
index e9b8676..2db1c40 100755
--- a/tests/now_family_utc.sh
+++ b/tests/now_family_utc.sh
@@ -3,12 +3,11 @@
 # addd 2016-01-12 by RGerhards, released under ASL 2.0
 # requires faketime
 echo \[now_family_utc\]: test \$NOW family of system properties
+
+. $srcdir/faketime_common.sh
+
 export TZ=TEST+06:30
-faketime '2016-01-01 01:00:00' date
-if [ $? -ne 0 ]; then
-    echo "faketime command missing, skipping test"
-    exit 77
-fi
+
 . $srcdir/diag.sh init
 faketime '2016-01-01 01:00:00' $srcdir/diag.sh startup now_family_utc.conf
 # what we send actually is irrelevant, as we just use system properties.
diff --git a/tests/timegenerated-dateordinal-invld.sh b/tests/timegenerated-dateordinal-invld.sh
index 9f19e7b..bac5d4e 100755
--- a/tests/timegenerated-dateordinal-invld.sh
+++ b/tests/timegenerated-dateordinal-invld.sh
@@ -5,12 +5,11 @@
 # instead provide the defined return value (0)
 # requires faketime
 echo \[timegenerated-dateordinal-invld\]: check invalid dates with ordinal format
+
+. $srcdir/faketime_common.sh
+
 export TZ=UTC+00:00
-faketime -f '2216-03-01 12:00:00' date
-if [ $? -ne 0 ]; then
-    echo "faketime command missing, skipping test"
-    exit 77
-fi
+
 . $srcdir/diag.sh init
 . $srcdir/diag.sh generate-conf
 . $srcdir/diag.sh add-conf '
diff --git a/tests/timegenerated-dateordinal.sh b/tests/timegenerated-dateordinal.sh
index a2193b1..ace1c16 100755
--- a/tests/timegenerated-dateordinal.sh
+++ b/tests/timegenerated-dateordinal.sh
@@ -5,12 +5,11 @@
 # from creating additional tests
 # requires faketime
 echo \[timegenerated-dateordinal\]: check valid dates with ordinal format
+
+. $srcdir/faketime_common.sh
+
 export TZ=UTC+00:00
-faketime -f '2016-03-01 12:00:00' date
-if [ $? -ne 0 ]; then
-    echo "faketime command missing, skipping test"
-    exit 77
-fi
+
 . $srcdir/diag.sh init
 . $srcdir/diag.sh generate-conf
 . $srcdir/diag.sh add-conf '
@@ -164,6 +163,9 @@ if [ ! $? -eq 0 ]; then
 fi;
 
 
+rsyslog_testbench_require_y2k38_support
+
+
 echo "***SUBTEST: check 2038-12-31"
 rm -f rsyslog.out.log	# do cleanup of previous subtest
 faketime -f '2038-12-31 12:00:00' $srcdir/diag.sh startup
diff --git a/tests/timegenerated-uxtimestamp-invld.sh b/tests/timegenerated-uxtimestamp-invld.sh
index ba5b374..90bcf74 100755
--- a/tests/timegenerated-uxtimestamp-invld.sh
+++ b/tests/timegenerated-uxtimestamp-invld.sh
@@ -5,12 +5,11 @@
 # instead provide the defined return value (0)
 # requires faketime
 echo \[timegenerated-uxtimestamp-invld\]: check invalid dates with uxtimestamp format
+
+. $srcdir/faketime_common.sh
+
 export TZ=UTC+00:00
-faketime -f '2216-03-01 12:00:00' date
-if [ $? -ne 0 ]; then
-    echo "faketime command missing, skipping test"
-    exit 77
-fi
+
 . $srcdir/diag.sh init
 . $srcdir/diag.sh generate-conf
 . $srcdir/diag.sh add-conf '
diff --git a/tests/timegenerated-uxtimestamp.sh b/tests/timegenerated-uxtimestamp.sh
index 4c06d23..b24f9c7 100755
--- a/tests/timegenerated-uxtimestamp.sh
+++ b/tests/timegenerated-uxtimestamp.sh
@@ -5,12 +5,11 @@
 # from creating additional tests
 # requires faketime
 echo \[timegenerated-uxtimestamp\]: check valid dates with uxtimestamp format
+
+. $srcdir/faketime_common.sh
+
 export TZ=UTC+00:00
-faketime -f '2016-03-01 12:00:00' date
-if [ $? -ne 0 ]; then
-    echo "faketime command missing, skipping test"
-    exit 77
-fi
+
 . $srcdir/diag.sh init
 . $srcdir/diag.sh generate-conf
 . $srcdir/diag.sh add-conf '
@@ -174,6 +173,9 @@ if [ ! $? -eq 0 ]; then
 fi;
 
 
+rsyslog_testbench_require_y2k38_support
+
+
 echo "***SUBTEST: check 2040-01-01"
 rm -f rsyslog.out.log	# do cleanup of previous subtest
 faketime -f '2040-01-01 12:00:00' $srcdir/diag.sh startup
diff --git a/tests/timegenerated-ymd.sh b/tests/timegenerated-ymd.sh
index e512b17..34c52e3 100755
--- a/tests/timegenerated-ymd.sh
+++ b/tests/timegenerated-ymd.sh
@@ -3,12 +3,11 @@
 # addd 2016-02-23 by RGerhards, released under ASL 2.0
 # requires faketime
 echo \[timegenerated-ymd\]: check customized format \(Y-m-d\)
+
+. $srcdir/faketime_common.sh
+
 export TZ=TEST-02:00
-faketime '2016-01-01 01:00:00' date
-if [ $? -ne 0 ]; then
-    echo "faketime command missing, skipping test"
-    exit 77
-fi
+
 . $srcdir/diag.sh init
 . $srcdir/diag.sh generate-conf
 . $srcdir/diag.sh add-conf '
